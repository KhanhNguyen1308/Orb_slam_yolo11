<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X99 ROBOTICS - SLAM COMMANDER</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            --bg-color: #0f1115;
            --panel-bg: #1a1d24;
            --accent: #00ff88;
            --text-main: #e0e0e0;
            --text-dim: #8b9bb4;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            height: 50px;
        }

        .logo { font-weight: bold; font-size: 1.2em; color: var(--accent); letter-spacing: 2px; }
        .status-badge { font-size: 0.8em; padding: 4px 10px; border-radius: 4px; background: #333; }
        .status-ok { background: rgba(0, 255, 136, 0.2); color: var(--accent); border: 1px solid var(--accent); }

        /* MAIN LAYOUT */
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px; /* Cột trái - Giữa - Cột phải */
            grid-template-rows: 1fr 200px;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 70px);
        }

        /* PANELS */
        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #333;
        }

        .panel-header {
            padding: 8px 15px;
            font-size: 0.85em;
            text-transform: uppercase;
            font-weight: 600;
            background: rgba(0,0,0,0.2);
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
        }

        /* VIDEO STREAMS */
        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Giữ tỷ lệ ảnh */
            background: #000;
        }

        /* 3D VIEWER */
        #viewer3d { width: 100%; height: 100%; background: #000; }

        /* STATS & LOGS */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
        }
        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
        }
        .stat-value { font-size: 1.2em; color: var(--accent); font-family: monospace; }
        .stat-label { font-size: 0.75em; color: var(--text-dim); }

        /* GRID LAYOUT ASSIGNMENTS */
        .area-camera { grid-column: 1; grid-row: 1; }
        .area-lidar  { grid-column: 1; grid-row: 2; } /* Map 2D ở dưới Camera */
        .area-3d     { grid-column: 2; grid-row: 1 / span 2; } /* 3D chiếm giữa full cao */
        .area-depth  { grid-column: 3; grid-row: 1; }
        .area-stats  { grid-column: 3; grid-row: 2; }

    </style>
</head>
<body>

    <header>
        <div class="logo">X99 <span style="color:white">SLAM</span></div>
        <div id="connection-status" class="status-badge">Connecting...</div>
    </header>

    <div class="main-container">
        
        <div class="panel area-camera">
            <div class="panel-header">Left Camera (RGB)</div>
            <img id="video-left" class="video-feed" src="/video/left" alt="Left Camera">
        </div>

        <div class="panel area-lidar">
            <div class="panel-header">
                <span>2D Occupancy Grid (LIDAR Mode)</span>
                <span style="color: var(--accent)">LIVE</span>
            </div>
            <img id="video-grid" class="video-feed" src="/video/grid" alt="2D Map" 
                 style="image-rendering: pixelated; transform: scaleY(-1);"> 
                 </div>

        <div class="panel area-3d">
            <div class="panel-header">3D Point Cloud Reconstruction</div>
            <div id="viewer3d"></div>
        </div>

        <div class="panel area-depth">
            <div class="panel-header">Depth Map (Heatmap)</div>
            <img id="video-depth" class="video-feed" src="/video/depth" alt="Depth Map">
        </div>

        <div class="panel area-stats">
            <div class="panel-header">System Telemetry</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="val-fps-slam">0.0</div>
                    <div class="stat-label">SLAM FPS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="val-fps-cam">0.0</div>
                    <div class="stat-label">Camera FPS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="val-points">0</div>
                    <div class="stat-label">Map Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">OK</div>
                    <div class="stat-label">YOLO GPU</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- KẾT NỐI SOCKET ---
        const socket = io();
        const statusDiv = document.getElementById('connection-status');

        socket.on('connect', () => {
            statusDiv.innerText = "SYSTEM ONLINE";
            statusDiv.classList.add('status-ok');
        });

        socket.on('disconnect', () => {
            statusDiv.innerText = "OFFLINE";
            statusDiv.classList.remove('status-ok');
        });

        socket.on('stats_update', (data) => {
            document.getElementById('val-fps-slam').innerText = (data.slam_fps || 0).toFixed(1);
            document.getElementById('val-fps-cam').innerText = (data.left_fps || 0).toFixed(1);
            if(data.persistent_map_points) {
                document.getElementById('val-points').innerText = (data.persistent_map_points / 1000).toFixed(1) + "k";
            }
        });

        // --- CẤU HÌNH 3D THREE.JS ---
        const init3D = () => {
            const container = document.getElementById('viewer3d');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            // Camera 3D
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 5, 5); // Đặt camera ở trên cao nhìn xuống
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Controls chuột
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Lưới nền (Grid Helper)
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Trục tọa độ (RGB = XYZ)
            const axesHelper = new THREE.AxesHelper(1);
            scene.add(axesHelper);

            // Robot ảo
            const robotGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.3);
            const robotMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff88, wireframe: true });
            const robot = new THREE.Mesh(robotGeometry, robotMaterial);
            scene.add(robot);

            // Animation Loop
            const animate = function () {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            };
            animate();

            // Resize handler
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        };

        // Khởi chạy 3D viewer
        init3D();

        // Auto-reconnect cho ảnh nếu bị lag
        document.querySelectorAll('img').forEach(img => {
            img.onerror = function() {
                setTimeout(() => {
                    this.src = this.src.split('?')[0] + '?t=' + new Date().getTime();
                }, 1000);
            };
        });

    </script>
</body>
</html>